variables:
  DOCKER_REGISTRY: docker.io
  DOCKERHUB_USERNAME: "alexandrevb" 

image:
  name: "python:3.11-alpine"
  entrypoint: ["/bin/sh", "-c"]

before_script:
  - apk update && apk add --no-cache docker curl bash
  - dockerd & 
  - sleep 5
  - curl https://raw.githubusercontent.com/helm/helm/master/scripts/get-helm-3 | bash
  - echo "$DOCKERHUB_PASSWORD" | docker login -u "$DOCKERHUB_USERNAME" --password-stdin


stages:
  - build
  - deploy_dev
  - deploy_QA
  - deploy_staging
  - deploy_prod

build-job:
  stage: build
  script:
    - echo "Hello, $GITLAB_USER_LOGIN! $DOCKER_REGISTRY/$DOCKERHUB_USERNAME/gitlab-exam"
    - docker build -t "$DOCKERHUB_USERNAME/gitlab-exam-gateway:latest" ./gateway/
    - docker build -t "$DOCKERHUB_USERNAME/gitlab-exam-orders:latest" ./orders/
    - docker build -t "$DOCKERHUB_USERNAME/gitlab-exam-users:latest" ./users/

    - docker push "$DOCKERHUB_USERNAME/gitlab-exam-gateway:latest"
    - docker push "$DOCKERHUB_USERNAME/gitlab-exam-orders:latest"
    - docker push "$DOCKERHUB_USERNAME/gitlab-exam-users:latest"


deploy_dev:
  stage: deploy_dev
  script:
    - rm -Rf .kube
    - mkdir .kube
    - cat $KUBE_CONFIG > .kube/config
    - helm upgrade --install app helm/ --values=values.yml --namespace dev

deploy_QA:
  stage: deploy_QA
  script:
    - rm -Rf .kube
    - mkdir .kube
    - cat $KUBE_CONFIG > .kube/config
    - helm upgrade --install app helm/ --values=values.yml --namespace qa

deploy_staging:
  stage: deploy_staging
  script:
    - rm -Rf .kube
    - mkdir .kube
    - cat $KUBE_CONFIG > .kube/config
    - helm upgrade --install app helm/ --values=values.yml --namespace staging
      
deploy_prod:
  stage: deploy_prod
  script:
    - rm -Rf .kube
    - mkdir .kube
    - cat $KUBE_CONFIG > .kube/config
    - helm upgrade --install app helm/ --values=values.yml --namespace prod
  rules:
    - if: $CI_COMMIT_BRANCH == "main"
      when: manual
